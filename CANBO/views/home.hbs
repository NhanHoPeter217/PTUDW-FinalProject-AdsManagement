{{#section 'css'}}
    <link href='public/css/utils.maps.css' rel='stylesheet' />
    <link rel='stylesheet' href='public/css/report.css' />
    <link rel="stylesheet" href="/public/css/adpointInfo.css">
    <style>
        .reportExclamation > img {
            transition: filter 0.1s ease-in-out; /* Add a transition effect */
        }

        .reportExclamation:hover > img {
            filter: brightness(0) invert(1); /* Adjust brightness and invert to change the color */
        }
    </style>
{{/section}}

<div id='root'>
    <div id='left-bar' class='col'>
        <div class='input-group mb-3 flex-nowrap'>
            <input
                type='text'
                class='form-control'
                placeholder='Tìm địa điểm'
                aria-label='Tìm địa điểm'
                aria-describedby='button-addon2'
                id='searchInput'
            />
        </div>
        <h3>Các bảng quảng cáo</h3>
        <div id="boards-container">
        {{#each AdsBoards}}
            <!-- Adboard{{inc @index}} -->
            <div
              class="ad-board card default-background primary-text"
              data-adsPoint="id_{{adsPoint}}"
              style="width: 20rem; padding: 17px 17px; gap: 40px; min-width: 350px;"
            >
              <div class="d-flex align-items-start">
                <div class="card-body ps-2" style="padding: 0px;">
                  <h5 class="card-title" style="font-size: 20px; font-family: Inter; font-weight: 600; margin-bottom: 4px;">{{adsBoardType}}</h5>
                  <p class="card-text">
                    <span class="label">Kích thước:</span>
                    <span class="value" style="font-size: 16px; font-family: Inter; font-weight: 700;">{{size.width}}m x {{size.height}}m</span>
                  </p>
                  <p class="card-text">
                    <span class="label">Số lượng:</span>
                    <span class="value" style="font-size: 16px; font-family: Inter; font-weight: 700;">{{quantity}} trụ / bảng</span>
                  </p>
                </div>
              </div>
            </div>
        {{/each}}
        </div>
    </div>
    <div id='map'>
    </div>
</div>

{{#ifCond auth.role '!==' 'Sở VH-TT'}}
<button
    id='report-canvas-button'
    class='btn btn-primary'
    type='button'
    data-bs-toggle='offcanvas'
    data-bs-target='#report-canvas'
    aria-controls='report-canvas'
>
    Tất cả báo cáo
</button>

<div
    class='offcanvas offcanvas-end'
    data-bs-backdrop='false'
    data-bs-scroll='true'
    tabindex='-1'
    id='report-canvas'
    aria-labelledby='report-canvasLabel'
>
    <div class='offcanvas-header'>
        <h5 class='offcanvas-title' id='report-canvasLabel'>Các Báo cáo đã nhận</h5>
        <button
            type='button'
            class='btn-close'
            data-bs-dismiss='offcanvas'
            aria-label='Close'
        ></button>
    </div>
    <div class='offcanvas-body d-flex flex-column row-gap-3' id="report-container">
        {{#each Reports}}
        <div class="report-element d-flex justify-content-between align-items-center" data-lat="{{coords.lat}}" data-lng="{{coords.lng}}">
            <div class="d-flex align-items-center">
                <img src="/public/assets/icons/Report_icon.svg" alt="" srcset="">
                <div class="details">
                    <div class="d-flex justify-content-between align-items-center column-gap-3">
                        <h5>{{reportFormat.name}}</h5>
                    </div>
                    {{!-- <h6>{{locationType}}</h6> --}}
                    <p class="mb-1">Phường <b>{{ward}}</b> Quận <b>{{district}}</b></p>
                    <p>Trạng thái: <b>{{processingStatus}}</b></p>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-primary" data-id="{{_id}}" data-bs-toggle="modal" data-bs-target="#detailReport-{{_id}}">Xem</button>
            </div>
        </div>


{{!-- Detail Report Modal --}}
<div
    class='modal fade detailReport'
    id='detailReport-{{_id}}'
    tabindex='-1'
    aria-labelledby='reportModalLabel'
    aria-hidden='true'
    data-lat="{{coords.lat}}"
    data-lng="{{coords.lng}}"
        >
    <div class='modal-dialog modal-dialog-centered modal-dialog-scrollable'>
        <div class='modal-content'>
            <div class='modal-header'>
                <img
                    src='../../../public/assets/icons/Info_icon.svg'
                    style='height: 40px; width: 40px;'
                />
                <h5 class='modal-detail-title' id='reportModalLabel'>Thông tin báo cáo</h5>
                <button
                    type='button'
                    class='btn-close'
                    data-bs-dismiss='modal'
                    aria-label='Close'
                ></button>
            </div>
            <div class='modal-detail-body'>
                <div class='mb-3 d-grid gap-2 me-2 ms-2 mt-2'>
                    <div class='card border'>
                        {{#ifCond relatedToType '===' 'AdsBoard'}}
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Loại báo cáo</h5>
                                <div><span class="fw-semibold text-primary">Bảng: </span><span class="fw-semibold text-primary">{{relatedTo.adsBoardType}}</span></div>
                        </div>
                        {{/ifCond}}
                        {{#ifCond relatedToType '===' 'AdsPoint'}}
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Loại báo cáo</h5>
                                <span class="fw-semibold text-primary">Điểm: </span><span class="fw-semibold text-primary">{{relatedTo.location.locationName}}</span>
                        </div>
                        {{/ifCond}}
                        {{#ifCond relatedToType '===' 'Location'}}
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Loại báo cáo</h5>
                                <span class="fw-semibold text-primary">Địa chỉ: </span><span class="fw-semibold text-primary">{{relatedTo.address}}</span>
                                <div class="map-view-only mt-2"></div>
                        </div>
                        {{/ifCond}}
                    </div>
                    <div class='card border'>
                        {{#ifCond relatedToType '===' 'AdsBoard'}}
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Địa chỉ</h5>
                            <p class='mb-0'>{{relatedTo.adsPoint.location.address}}</p>
                            <div class="map-view-only mt-2"></div>
                        </div>
                        {{/ifCond}}
                        {{#ifCond relatedToType '===' 'AdsPoint'}}
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Địa chỉ</h5>
                            <p class='mb-0'>{{relatedTo.location.address}}</p>
                            <div class="map-view-only mt-2"></div>
                        </div>
                        {{/ifCond}}
                    </div>
                    <div class="row gx-2">
                        <div class='col-md-6'>
                            <div class='card border'>
                                <div class='card-body'>
                                    <h5 class='card-title fw-semibold mb-4'>Quận</h5>
                                    <p class='mb-0'>{{district}}</p>
                                </div>
                            </div>
                        </div>
                        <div class='col-md-6'>
                            <div class='card border'>
                                <div class='card-body'>
                                    <h5 class='card-title fw-semibold mb-4'>Phường</h5>
                                    <p class='mb-0'>{{ward}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class='card border'>
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Hình thức báo cáo</h5>
                            <p class='mb-0'>{{reportFormat.name}}</p>
                        </div>
                    </div>
                    <div class='card border'>
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Nội dung báo cáo</h5>
                            <p class='mb-0'>{{{content}}}</p>
                            {{!-- <div id="reportContent"></div> --}}
                        </div>
                    </div>
                    <div class='card border'>
                        <div class='card-body'>
                            <h5 class='card-title fw-semibold mb-4'>Hình ảnh</h5>
                            {{#each images as |image|}}
                            <img src="{{image}}" width="650" class="mb-2">
                            {{else}}
                            <p class='mb-0 text-warning fw-semibold'>Không có hình ảnh</p>
                            {{/each}}
                        </div>
                    </div>
                    <div class="card border">
                    {{#ifCond processingStatus '===' 'Đã xử lý'}}
                    <div class='card-body'>
                        <h5 class='card-title fw-semibold mb-4'>Tình trạng</h5>
                        <span class="badge bg-success rounded-3 fw-semibold">Đã xử lý</span>
                    </div>
                    {{/ifCond}}
                    {{#ifCond processingStatus '===' 'Đang xử lý'}}
                    <div class='card-body'>
                        <h5 class='card-title fw-semibold mb-4'>Tình trạng</h5>
                        <span class="badge bg-warning rounded-3 fw-semibold">Đang xử lý</span>
                    </div>
                    {{/ifCond}}
                    {{#ifCond processingStatus '===' 'Chưa xử lý'}}
                    <div class='card-body'>
                        <h5 class='card-title fw-semibold mb-4'>Tình trạng</h5>
                        <span class="badge bg-danger rounded-3 fw-semibold">Chưa xử lý</span>
                    </div>
                    {{/ifCond}}
                    </div>
                    <form data-id="{{_id}}" class="tackle-form">
                        <div class='mb-3'>
                            <label class='form-label' style='font-family: Inter;'>Cách thức xử lý</label>
                            <textarea
                                class='form-control'
                                name="processingMethod"
                                style="height: 100px;"
                                required
                            >{{processingMethod}}</textarea>
                        </div>
                        <div class='mb-3'>
                            <label class='form-label' style='font-family: Inter;'>Tình trạng xử lý</label>
                            <select class="form-select badge bg-light rounded-3 fs-6 text-body-emphasis" name="processingStatus">
                                <option value="Chưa xử lý" class="bg-white text-primary">Chưa xử lý</option>
                                <option value="Đang xử lý" class="bg-white text-primary">Đang xử lý</option>
                                <option value="Đã xử lý" class="bg-white text-primary">Đã xử lý</option>
                            </select>
                        </div>
                        <div class='button-container justify-content-center'>
                            <div class='d-grid gap-2 col-3 mx-auto'>
                                <button
                                    type='submit'
                                    class='btn btn-primary m1'
                                    style='font-family: Inter'
                                >
                                    CẬP NHẬT
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
        {{/each}}
    </div>
</div>
{{/ifCond}}

{{!-- Elements for adPoint markers --}}
{{#each AdsPoints}}
{{#ifCond planningStatus '===' 'Đã quy hoạch'}}
<div class="adpointInfo adPointBlue" data-id="{{_id}}" data-lat="{{location.coords.lat}}" data-lng="{{location.coords.lng}}">
{{else}}
<div class="adpointInfo adPointRed" data-id="{{_id}}" data-lat="{{location.coords.lat}}" data-lng="{{location.coords.lng}}">
{{/ifCond}}
    <div class="markerPlaceholder" alt="" srcset="">{{adsBoard.length}}</div>

    {{#ifCond planningStatus '===' 'Đã quy hoạch'}}
    <img src="/public/assets/icons/Info_icon_Blue.svg" class="icon" alt="" srcset=""/>
    {{else}}
    <img src="/public/assets/icons/Info_icon_Red.svg" class="icon" alt="" srcset=""/>
    {{/ifCond}}

    <div class="details">
        <div class="d-flex justify-content-between align-items-center column-gap-3">
            <!-- location.locationName -->
            <h5>{{location.locationName}}</h5>
            <meta name="planningStatus" content="{{planningStatus}}"></meta>
        </div>
        <!-- locationType -->
        <h6>{{locationType}}</h6>
        <!-- location.address -->
        <p class="mb-1">Phường <b>{{location.ward}}</b> Quận <b>{{location.district}}</b></p>
        <p>Trạng thái: <b>{{planningStatus}}</b></p>
    </div>
</div>
{{/each}}

<!-- Filter Board -->
<div class="filterBoard shadow-sm">
    <div class='form-check form-switch'>
        <input class='form-check-input' type='checkbox' role='switch' id='filterButton' checked />
        <label class='form-check-label' for='filterButton'>Điểm đặt</label>
    </div>
    {{#ifCond auth.role '!==' 'Sở VH-TT'}}
    <div class='form-check form-switch'>
        <input class='form-check-input' type='checkbox' role='switch' id='reportFilterButton' checked />
        <label class='form-check-label' for='reportFilterButton'>Báo cáo</label>
    </div>
    {{/ifCond}}
</div>


{{#section 'js'}}
    {{! Google Maps Functions }}
    <script>
        const nav = $( "#navbar" )
        $( document ).ready( function() {
            $( "#left-bar" ).css( {"height": $(window).height() - nav.height() - 16} );
        } );

        $( window ).on( "resize", function() {
            $( "#left-bar" ).css( {"height": $(this).height() - nav.height() - 16} );
        } );
    </script>

    </script>
    {{! Marker Clusterer }}
    <script src='https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js'></script>

    <script src="/public/tinymce/js/tinymce/tinymce.min.js"></script>
    <script src="/public/js/tinymce.js"></script>

    <script src="/public/js/main.js" type="module"></script>
    <script>

    function initSendReport() {
        // Send report
        $('.tackle-form').on('submit', function (e) {
            e.preventDefault();

            let id = this.getAttribute('data-id');
            const modal = $('#detailReport-' + id);
            let processingStatus = modal.find('select[name="processingStatus"]').val();
            let processingMethod = modal.find('textarea[name="processingMethod"]').val();
            console.log(processingStatus, processingMethod);

            if (processingStatus == '' || processingMethod == '') {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            axios
                .patch('/report/' + id, {
                    processingStatus,
                    processingMethod
                })
                .then(function (response) {
                    alert('Cập nhật thành công!');
                    window.location.reload();
                })
                .catch(function (error) {
                    alert('Cập nhật thất bại!');
                });
        });
    }

    initSendReport();

    </script>
{{/section}}